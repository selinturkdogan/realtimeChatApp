<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChatApp</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <body>
  <div class="welcome-modal" id="welcomeModal">
    <div class="welcome-content">
      <h2>Welcome!</h2>
      <p>Please enter your name to join:</p>
      <input type="text" id="nameInput" class="name-input" placeholder="Name" />
      <button id="joinBtn" class="join-button">Join</button>
    </div>
  </div>

  <div class="chat-container" style="display:none;">
    <div class="chat-main">
      <div class="chat-header">
        <h2 id="chatWith">Choose chat</h2>
      </div>
      <ul id="messages" class="messages-container"></ul>
      <div id="typingIndicator" class="typing-indicator" style="display:none;"></div>
      <div class="input-container">
        <form id="inputForm" class="input-form">
          <input type="text" id="input" autocomplete="off" placeholder="write a message..." />
          <button type="submit" class="send-button">&#9658;</button>
        </form>
      </div>
    </div>
    <div class="chat-sidebar">
      <h3>Chats</h3>
      <ul id="usersList"></ul>
      <!-- Create Group button now properly placed inside sidebar -->
      <button id="createGroupBtn" class="create-group-btn">
        <i class="fas fa-users"></i> Create Group
      </button>
    </div>
  </div>

  <!-- Grup oluÅŸturma modalÄ± -->
  <div id="createGroupModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>Create Group</h2>
      <input type="text" id="groupNameInput" placeholder="Group name" />
      <h3>Select members:</h3>
      <div id="onlineUsersList"></div>
      <div class="modal-buttons">
        <button id="submitGroupBtn" class="modal-button submit">Create</button>
        <button id="cancelGroupBtn" class="modal-button cancel">Cancel</button>
      </div>
    </div>
  </div>
<script>
  let socket;
  let myName = null;
  let activeChatId = null;

  // DOM elements
  const welcomeModal = document.getElementById('welcomeModal');
  const nameInput = document.getElementById('nameInput');
  const joinBtn = document.getElementById('joinBtn');
  const chatContainer = document.querySelector('.chat-container');
  const usersList = document.getElementById('usersList');
  const messagesList = document.getElementById('messages');
  const chatWith = document.getElementById('chatWith');
  const inputForm = document.getElementById('inputForm');
  const input = document.getElementById('input');
  const typingIndicator = document.getElementById('typingIndicator');
  const createGroupBtn = document.getElementById('createGroupBtn');
  const createGroupModal = document.getElementById('createGroupModal');
  const groupNameInput = document.getElementById('groupNameInput');
  const onlineUsersList = document.getElementById('onlineUsersList');
  const submitGroupBtn = document.getElementById('submitGroupBtn');
  const cancelGroupBtn = document.getElementById('cancelGroupBtn');

  const users = new Map();
  const groups = new Map();
  const chatHistories = new Map();

  // KullanÄ±cÄ± adÄ± ile baÄŸlanma
  joinBtn.onclick = () => {
    const name = nameInput.value.trim();
    if (!name) return alert('Please enter a name.');

    myName = name;
    socket = io({ query: { name } });

    welcomeModal.style.display = 'none';
    chatContainer.style.display = 'flex';

    // KullanÄ±cÄ± listesi gÃ¼ncelleme
    socket.on('user list', (userArray) => {
      users.clear();
      userArray.forEach(u => {
        if (u.id !== socket.id) users.set(u.id, u.name);
      });
      renderUserAndGroupList();
    });

    // Ã–zel mesaj alma
    socket.on('private message', ({ from, text, timestamp, own }) => {
      if (own) return;

      const senderId = [...users.entries()].find(([id, n]) => n === from)?.[0];
      if (!senderId) return;

      if (!chatHistories.has(senderId)) chatHistories.set(senderId, []);
      chatHistories.get(senderId).push({ from, text, timestamp, own: false });

      if (activeChatId === senderId) {
        addMessage({ from, text, timestamp, own: false });
      }
    });

    // Grup oluÅŸturulduÄŸunda
    socket.on('group created', ({ groupId, groupName, members }) => {
      groups.set(groupId, {
        name: groupName,
        members
      });
      renderUserAndGroupList();
    });

    // Grup mesajÄ± aldÄ±ÄŸÄ±nda
    socket.on('group message', ({ groupId, from, text, timestamp, own }) => {
      if (!chatHistories.has(groupId)) chatHistories.set(groupId, []);
      chatHistories.get(groupId).push({ from, text, timestamp, own });
      
      if (activeChatId === groupId) {
        addMessage({ from, text, timestamp, own });
      }
    });

    // TYPING eventini dinle
    socket.on('typing', ({ from, typing, groupId }) => {
      if (groupId) {
        // Grup typing indicator
        if (activeChatId === groupId && typing) {
          typingIndicator.textContent = `${from} is typing...`;
          typingIndicator.style.display = 'block';
        } else if (activeChatId === groupId && !typing) {
          typingIndicator.style.display = 'none';
        }
      } else {
        // Bireysel sohbet typing indicator
        const senderId = [...users.entries()].find(([id, n]) => n === from)?.[0];
        if (typing && activeChatId === senderId) {
          typingIndicator.textContent = `${from} is typing...`;
          typingIndicator.style.display = 'block';
        } else {
          typingIndicator.style.display = 'none';
        }
      }
    });
  };

  // KullanÄ±cÄ± ve grup listesini gÃ¶sterme
  function renderUserAndGroupList() {
    usersList.innerHTML = '';
    
    // Bireysel kullanÄ±cÄ±lar
    users.forEach((name, id) => {
      const li = document.createElement('li');
      li.textContent = name;
      li.dataset.id = id;
      li.className = (activeChatId === id) ? 'active-user' : '';
      li.onclick = () => openChat(id, name);
      usersList.appendChild(li);
    });
    
    // Gruplar
    groups.forEach((group, groupId) => {
      const li = document.createElement('li');
      li.textContent = `ðŸ’¬ ${group.name}`;
      li.dataset.id = groupId;
      li.className = (activeChatId === groupId) ? 'active-group' : '';
      li.onclick = () => openGroupChat(groupId, group.name);
      usersList.appendChild(li);
    });
  }

  // Bireysel sohbet aÃ§ma
  function openChat(id, name) {
    activeChatId = id;
    chatWith.textContent = name;
    typingIndicator.style.display = 'none';
    renderUserAndGroupList();
    renderMessages();
  }

  // Grup sohbeti aÃ§ma
  function openGroupChat(groupId, groupName) {
    activeChatId = groupId;
    chatWith.textContent = `${groupName} (Group)`;
    typingIndicator.style.display = 'none';
    renderUserAndGroupList();
    renderMessages();
  }

  // MesajlarÄ± ekrana yazdÄ±rma
  function renderMessages() {
    messagesList.innerHTML = '';
    const history = chatHistories.get(activeChatId) || [];
    history.forEach(msg => addMessage(msg));
    messagesList.scrollTop = messagesList.scrollHeight;
  }

  // Mesaj elemanÄ± oluÅŸturma
  function addMessage({ from, text, timestamp, own }) {
    const li = document.createElement('li');
    li.className = 'message ' + (own ? 'own' : '');

    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.textContent = from.charAt(0).toUpperCase();

    const content = document.createElement('div');
    content.className = 'message-content';

    const sender = document.createElement('div');
    sender.className = 'message-sender';
    sender.textContent = from;

    const messageText = document.createElement('div');
    messageText.className = 'message-text';
    messageText.textContent = text;

    const time = document.createElement('div');
    time.className = 'message-time';
    time.textContent = new Date(timestamp).toLocaleTimeString();

    content.appendChild(sender);
    content.appendChild(messageText);
    content.appendChild(time);

    li.appendChild(avatar);
    li.appendChild(content);

    messagesList.appendChild(li);
    messagesList.scrollTop = messagesList.scrollHeight;
  }

  // Yazarken typing event gÃ¶nder
  input.addEventListener('input', () => {
    if (!activeChatId) return;
    
    if (activeChatId.startsWith('group_')) {
      socket.emit('typing', { 
        to: activeChatId, 
        typing: input.value.length > 0 
      });
    } else {
      socket.emit('typing', { 
        to: activeChatId, 
        typing: input.value.length > 0 
      });
    }
  });

  // Mesaj gÃ¶nderme
  inputForm.onsubmit = (e) => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;
    
    const timestamp = new Date();
    
    if (!activeChatId) return alert('Please select a chat first');
    
    if (activeChatId.startsWith('group_')) {
      // Grup mesajÄ±
      if (!chatHistories.has(activeChatId)) chatHistories.set(activeChatId, []);
      chatHistories.get(activeChatId).push({ 
        from: myName, 
        text, 
        timestamp, 
        own: true 
      });
      addMessage({ from: myName, text, timestamp, own: true });
      
      socket.emit('group message', { 
        groupId: activeChatId, 
        text 
      });
    } else {
      // Bireysel mesaj
      if (!chatHistories.has(activeChatId)) chatHistories.set(activeChatId, []);
      chatHistories.get(activeChatId).push({ 
        from: myName, 
        text, 
        timestamp, 
        own: true 
      });
      addMessage({ from: myName, text, timestamp, own: true });
      
      socket.emit('private message', { 
        to: activeChatId, 
        text 
      });
    }
    
    input.value = '';
    
    // Typing gÃ¶stergesini kapat
    if (activeChatId.startsWith('group_')) {
      socket.emit('typing', { to: activeChatId, typing: false });
    } else {
      socket.emit('typing', { to: activeChatId, typing: false });
    }
  };
  
  // Grup oluÅŸturma modal iÅŸlemleri
  createGroupBtn.onclick = () => {
    createGroupModal.style.display = 'block';
    
    // Online kullanÄ±cÄ±larÄ± listele (checkbox'lÄ±)
    onlineUsersList.innerHTML = '';
    users.forEach((name, id) => {
      const userDiv = document.createElement('div');
      userDiv.className = 'group-user-item';
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = `user_${id}`;
      checkbox.value = name;
      
      const label = document.createElement('label');
      label.htmlFor = `user_${id}`;
      label.textContent = name;
      
      userDiv.appendChild(checkbox);
      userDiv.appendChild(label);
      onlineUsersList.appendChild(userDiv);
    });
  };

  submitGroupBtn.onclick = () => {
    const groupName = groupNameInput.value.trim();
    if (!groupName) return alert('Enter group name');
    
    const selectedUsers = [];
    document.querySelectorAll('#onlineUsersList input[type="checkbox"]:checked').forEach(checkbox => {
      selectedUsers.push(checkbox.value);
    });
    
    if (selectedUsers.length === 0) return alert('Select at least one member');
    
    socket.emit('create group', {
      groupName,
      members: selectedUsers
    });
    
    createGroupModal.style.display = 'none';
    groupNameInput.value = '';
  };

  cancelGroupBtn.onclick = () => {
    createGroupModal.style.display = 'none';
  };
</script>
</body>
</html> 